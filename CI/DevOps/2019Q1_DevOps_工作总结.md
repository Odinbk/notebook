# DevOps 2019一季度工作总结

## Walle打包系统

2018-12月由Owen牵头，联合前后端专家组，支撑部DevOps项目组开始对Walle打包系统改造。 改造的目标是规范统一公司游戏项目打包过程， 建立中心化的打包配置中心， 明确打包过程中各方的职责， 缩短打包系统接入时间。

到一季度结束，项目经历了三个阶段：

#### 2018-12 ~ 2019-01

项目立项，确定Walle + Jenkins + Ceph Resource Center + ZooKeeper的技术方案。 项目攻坚， DK项目接入新的打包系统。

#### 2019-01 ~ 2019-02

代码重构，添加必要的自动化测试，提高系统稳定性。 核心打包功能趋于稳定。

#### 2019-02 ~ 2019-03

确定审核服/灰度发布的技术方案， 开发服务器端热更新， 客户端GameStatic/Patch功能。
Vega项目接入新的打包系统。

### 季度目标及完成情况

#### 1. 提高打包系统稳定性

3月份DK进入了频繁打包交付的阶段， 除了Jenkinsfile中手动SVN Revert行为导致的打包机Docker崩溃问题外， 打包系统本身目前运行非常稳定。 从打包通知群的历史记录和几次支持DK打包过程可见一斑。 

#### 2. 完善打包系统功能

新的打包系统基本上支持了项目组常用的功能：

* 客户端/服务器端独立出包， 完整出包。
* 客户端出热更新包。
* 服务器端热更新。
* 客户端GameStatic/Patch
* 客户端/服务器端灰度发布 - 验收测试中
* 审核服 - 验收测试中

4月2日 ~ 4月4日Vega项目组安排QA李栋梁对新的系统测试评估， 李栋梁针对易用性和功能性给了一些建议， 纳入二季度计划中。

#### 3. Vega项目接入

Vega项目从2月11日开始正式对接新的打包系统， 期间由于接入腾讯SDK中断一周， 到2月28日前后端CI过程接入完毕， 可以通过Walle打出完整包和客户端更新包， 完成第一阶段的接入工作。
3月份服务器端对服务器代码适配ZooKeeper配置中心进行调整， 3月中旬时基本完成 -- 服务可以正常启动， 客户端可以游戏， 热更新。
后续验收测试服务器热更新，GameStatic/Patch等功能； 实现审核服， 灰度发布等。
目前接入Vega还剩审核服， 灰度发布验收测试， 迁移到正式环境等工作， 计划在4月中旬完成。

### 总结

|做得好的地方|做得不好的地方|改进方向|
|---|---|---|
|打包系统的稳定性有了大幅提升||
|加强了同项目组的沟通，建立重要时间节点提前告知参与者的机制。||
|打包系统功能基本完整。||
||接入Vega时间拉得太长, CI/CD流程对项目组的介绍不够。|明确支撑组和项目组各自的自责：项目组要了解新打包系统必要的细节；支撑组提供全面的文档，培训和支持。避免Copy/Paste代码。|
||多方沟通成本高，时间碎片化导致效率低。|涉及项目组，DevOps，Ops合作的项目，集中时间，集中人员，一鼓作气完成开发，测试。|

## 支撑组项目梳理/精简

一季度伊始， 支撑部到底维护着多少项目， 哪些项目还有维护的价值， 项目之间如何依赖， 项目在线上部署在何处如何部署， 处在说不清道不明的处境。 项目文档缺失， 即使有部分文档也散落在Gitlab中近90多个仓库中， 没有统一的规划和规范。

### 季度目标及完成情况

#### 1. 摸清还在使用， 有维护价值的项目， 整理归档废弃的仓库。

* 确认维护的项目: OMTools， 天梯， 高达， 讲武堂， Notice， UCenter， CMDB， Walle3(Vega), Thomas(Vega)。
* 归档了50+ Gitlab上的代码仓库。

#### 2. 为维护的项目添加README， 整理服务部署流程， 绘制线上部署架构图/服务依赖关系图。

* 处于维护状态的项目都添加了README文档，描述了项目的目的和部署流程。
* 处于维护状态的项目都绘制了线上部署架构图。
* 绘制了项目之间依赖关系图谱。

#### 3. 中心化的文档管理。

* 支撑部只为Ops的DevOps分别维护一个Gitlab文档项目。 整理项目相关的文档到对应的项目Wiki中。

### 总结

|做得好的地方|做得不好的地方|改进方向|
|---|---|---|
|建立支撑部项目规范：文档管理，项目部署，线上服务图例，开发/上线流程。||
|支撑部内部项目摸底，完善继续要支持的项目文档，资料；整理归档废弃的项目。降低维护成本，做到心中有数。||
||项目架构重叠度高：支撑部的项目基本上是一个WebUI，一些要执行的脚本，一个简单的生产者-消费者队列。|抽取相似的功能成为基础服务，项目整合为一个站点，多个子功能。降低部署，维护成本。|

## 支撑组项目容器化

支撑部项目容器化在2018年第四季度已经做过一轮，部分项目也已经部署到K8s中。但是也暴露出来一些问题：

* 流程太长，过于复杂。考虑不周全，资源只管创建，不管回收。
* 项目组参与度过低，对容器化技术不了解，维护工作落在DevOps身上。
* 接入项目类型单一，不能覆盖支撑部项目类型。

### 季度目标及完成情况

#### 1. 容器化工作流程的开发和实践

* 项目组开发自己开发维护Dockerfile和K8s编排。
* 项目达到接入K8s的前置条件。

#### 2. 资源清理

* 阿里云上无用的命名空间, 镜像, dns资源。
* 前期技术验证在公司kubernetes上创建的命名空间，jenkins上创建的job，gitlab中废弃的k8s相关代码仓库。

#### 3. 最佳实践的整理和实践

* 整理了容器化入门知识 wiki 帮助开发人员熟悉和使用 docker 技术栈; 整理容器化最佳实践，在devops，pdg项目上实践。
* 整理了容器化案例，涵盖了内部项目所使用的常见技术栈：java，python，php，nodejs
* devops 核心应用, pdg 项目组的应用接入k8s

### 总结

| 做的好的地方 | 做的不好的地方  | 改进方向 |
| --- | --- | --- |
| 容器化基础设施逐步完善和稳定|||
| 内网缓存系统的建设加速了镜像的构建效率 |||
| 规范化的流程让应用上线k8s更加自然和顺畅|||
|| 目前上线k8s应用的日志方案目前比较简陋 | k8s下日志收集接入ELK，规范支撑部项目日志格式，方便统计分析。|