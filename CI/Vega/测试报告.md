# 审核服/灰度服测试报告

* 时间: 4月15日 ~ 4月26日
* 测试对象: Vega CI分支
* 参与测试人员:
  * 客户端: 穆建辰，阎杨将
  * 服务端:  王贤蛟, 胡笳
  * DevOps: 杨光
  * Ops: 孙亮

## 审核服

设计文档

* [客户端设计文档](https://git.youle.game/TC/TSD/DevOps/dune/wikis/%E5%89%8D%E7%AB%AF%E6%96%87%E6%A1%A3/apple-review-version)
* [服务端设计文档](https://git.youle.game/TC/TSD/DevOps/dune/wikis/%E5%90%8E%E7%AB%AF%E6%96%87%E6%A1%A3/appstore_review_and_gray)

### 测试环境

* CICD部署位置作为正式服，yace部署位置作为审核服。

### 测试用例

* 打审核服包，在审核服部署位置发布(ver: 1).
  * 审核服可以正常游戏；正式服不能更新到审核服版本。
* 打审核服更新包，在审核服部署位置发布(ver: 2).
  * 审核服可以正常升级到最新版本: (ver: 1) ==> (ver: 2)；正式服不能更新到审核服版本。
* 正式服发布升级包(ver: 3).
  * 正式服可以正常升级到最新版本: (ver: 0) ==> (ver: 3)；审核服不能更新到正式版本。
* 切审核版本到正式版本，Walle上操作, 允许正式服更新, 版本+1: (ver: 4).
  * 审核服可以更新到最新版本 (ver: 2) => (ver: 4)
  * 正式服可以更新到最新版本 (ver: 3) => (ver: 4)
* 切审核版本到正式版本，Walle上操作, 不允许正式服更新, 版本+1: (ver: 4).
  * 审核服可以更新到最新版本 (ver: 2) => (ver: 4)
  * 正式服不可以更新到最新版本


### 问题

* 发布审核服，托马斯把更新包推送到了按照部署位置区分的CDN目录，导致vms返回给前端的更新包地址不匹配.
  * Fixed: 将所有前端包都放在游戏CDN的根目录下，不按照部署位置隔离. 前端包在文件名中要么是md5，要么是包含版本信息，所以不会有冲突的情况.
* 审核服的发布操作，需要先发布审核服，再发布正式服。由于天梯流程执行在不同的部署位置，不能串联起来，容易操作错误.
  * Fixed: 打包脚本取消审核服和正式服之间交叉打包的逻辑. 审核服打升级包不需要在正式服的部署位置发布，更新ZooKeeper中的数据。切换审核版本为正式版本需要在Walle上重新出包，在正式服发布版本时会把审核服上打的升级包相关信息写入正式服的ZooKeeper.

## 灰度发布

设计文档

* [客户端设计文档](https://git.youle.game/TC/TSD/DevOps/dune/wikis/%E5%89%8D%E7%AB%AF%E6%96%87%E6%A1%A3/gray-server)
* [服务端设计文档](https://git.youle.game/TC/TSD/DevOps/dune/wikis/%E5%90%8E%E7%AB%AF%E6%96%87%E6%A1%A3/appstore_review_and_gray)

### 测试环境

* CICD部署位置.

### 测试用例

* 灰度服发布版本(gray_ver:2)
  * 客户端默认进入为正式服, 选择灰度服然后更新版本：(ver:1)==>(gray_ver:2)
  * 再切回正式服
* 灰度服更新版本(gray_ver:3)
  * 客户端如果上次是在灰度服，直接更新版本：(gray_ver:2)==>(gray_ver:3)
  * 如果是在正式服，选择灰度服然后更新版本：(ver:1)==>(gray_ver:3)
  * 再切回正式服
* 正式服更新版本(ver:4)：
  * 灰度服不解除灰度，正式服客户端可以正常更新版本：(ver:1)==>(ver:4)
  * 本地有灰度服版本：正式服可以直接切换灰度服
  * 本地没有灰度服版本，需更新版本：(ver:1)==>(gray_ver:3)
  * 再切回正式服
* 灰度服解除灰度，Walle上操作，版本+1(ver: 5)：
  * 正式服可以正常升级到最新版本(ver:4)==>(ver:5)
  * 灰度服可以正常升级到最新版本(gray_ver:3)==>(ver:5)
* 正式服更新(ver:6)：
  * 正式服可以正常升级到最新版本(ver:5)==>(ver:6)

### 问题

* Walle上已发布的灰度版本显示还是未部署.
  * Fixed
* Walle上模块Tag是按照ID来排序的，存在连续打两个tag，后打的先完成，导致后打的Tag在排序上落后于先打的Tag。
  * Won't Fix: 由于Jenkins任务是并发构建的，不能保证任务完成的顺序。该问题在连续触发两次CI时有几率发生，操作打包的人注意选择正确的Tag是可以避免.