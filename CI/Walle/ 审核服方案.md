# 弹性发布方案

虽然本次改造的动机是为了支持多个审核服，但是改造后也能支持多个灰度的需求。
设计的假设是审核服和正式服采用隔离的部署位置，灰度服和正式服使用相同的部署位置。但是新的方案可以做到部署位置透明的效果，即审核服可以和正式服共享部署位置。

## 概念，术语

* Release（发布名称）：一个包对应一个Release，同一个部署位置上可以发布多个Release的版本。
* ReleaseType（发布类型）：按照业务需求对Release的组织，例如：Production，Gray，Review。
* DefaultRelease（默认发布类型）: 一个部署位置只能对应一个DefaultRelease, 意义在于当把一个包当做正式版本发布时找到它对应的正式服部署位置。

## 思路

* 消灭ReleaseType对服务端的影响，服务端只是按照配置和参数把服务启动运行起来，不参与不同发布类型之间的逻辑处理。
* 把需要对不同ReleaseType需要特殊处理的逻辑上移到打包过程，后面的流程只是拿到一个包，把包无差别的发布到线上。
* 添加/删除审核，灰度Release，只需要在WallE上更改配置，对下游流程透明，不需要更改任何代码。

## ZK中的数据组织形式

```code
# 新加入的配置结
/default_release

# 改名的配置结，增加releases根节点。加入前缀的意义在于根据version_id，section_id或者inner_ip反查对应的Release时，直接遍历/releases根下的子节点即可。
/releases/{release}/versions  
/releases/{release}/servers
/releases/{release}/global_url

```

## 服务端包组织形式

```code
.
├── filecache
│   ├── {release}.config.zoo （改名的文件，之前叫做config.zoo）
│   ├── release_indicator.json (新加入的文件)
├── lib
│   ├── dk-server
│   ├── global
│   └── vms
└── version
    ├── dataconfig
    │   ├── Numeric#Development#17253
    │   ├── Numeric#Development#17312
    │   └── Numeric#Development#17342
    ├── gameserver
    │   ├── dev.190122.01
    │   ├── dev.190122.02
    │   └── dev.190123.03
    ├── global
    │   └── dev.190122.01
    └── vms
        ├── dev.190122.01
        └── vms-notice.181230.11
```

## WallE承担的职责

1. 维护ReleaseType和Release的关系，增加了SpecialRelease表来记录。
2. 审核服的Release直接读取CMDB中对应部署位置的名称，保证唯一。
3. 灰度服的Release在WallE提供的页面中创建。
4. 原来由eve控制的，根据ReleaseType交叉打包的逻辑上移到WallE，剔除eve对ReleaseType的依赖。

## Pipeline打包脚本的职责

1. 不关心发布类型的细节，根据WallE传递的配置，创建版本升级包。例如：WallE传递参数{'from_version': 'c-1', 'to_version': 'c-2'}，打包脚本生成c-1_c-2的升级包。
2. 生成服务端包。和之前的设计差别在于包的filecache目录下需要包含两个文件：

* release_indicator.json 标记服务端包的Release(发布类型)。内容如下:

  ```json
    {
      "name": "production"
    }
  ```

  * 设计成json格式方便将来有扩展的需求。
  * 该值在发布正式版本时写入ZooKeeper的/default_release配置结下，发布审核或者灰度版本时忽略不写入，由天梯流程控制是否执行。
  * /default_release配置结存在的意义是标记该部署位置的正式版本是谁。在切换审核或者灰度版本上线时，能找到正式版本的节点，并将版本信息追加进去。
  * 可以发现，正式版本的名称不一定硬编码为production，增加了代码的灵活性。减少硬编码和隐式约定就会减少潜在bug出现的机会。不过暂时这个值在WallE中还是硬编码为production，为的是和当前版本兼容，避免影响还没有改造的项目组打包。
* {release}.config.zoo 该文件和之前版本的差异在于文件名前面加上了Release前缀。之所以这么做是为了解决在同一目录下解压缩服务端包，config.zoo文件覆盖的问题。由于服务端包中config.zoo是没有版本标志信息的，所以在同一个目录下解压缩不同Release的服务端包会导致config.zoo文件覆盖，存在将不合适的Release config.zoo更新到ZooKeeper中的隐患。

## Tools运维脚本的职责

不关心发布类型细节，游戏服务启停，操作ZooKeeper中的配置。

### 启动服务

* 根据服务运维脚本传入的section_id（区服id）或者本机的inner_ip，遍历ZooKeeper的/releases/{release}/servers或sections节点（这两个节点的数据会在版本发布时由Tools脚本写入），查找section_id或inner_ip对应的Release发布类型。再构造出对应Release的路径，从ZooKeeper中查找出相应的数据，执行启服命令。
* 对于需要知道Release的服务，例如GameServer通过Release的名字，连接配置给对应Release的BattleServer。通过启服参数中包含Release来传递参数。这里需要对应的游戏服务支持接收Release参数。

### 设置审核, 灰度版本

* 接受天梯流程传入的Release参数，从服务端包中读取对应的{release}.config.zoo中的内容，写入到ZooKeeper的/releases/{release}配置结下。一般包括: versions，global_url, sections, servers子节点。
* 举个例子，VMS通过检查参数传递的版本是否在/releases/appstore_review/versions来判断该版本是否是审核版本，进而读取/release/appstore_review/global_url中的GlobalServer地址，连接到专门给审核使用的GlobalServer。

## 天梯的职责

* 在天梯上配置适合各种发布类型（ReleaseType）的发布流程，并对传入的参数做校验。
* 例如，正式版本发布流程中需要执行额外的步骤，把服务端包中release.indicator.json文件中描述的信息写入到ZooKeeper中，目前设置了/default_release。 在审核版本或者灰度版本发布的流程中则不配置该步骤。
* 在切审核或者灰度版本上线的流程中，需要传入要切上线包名，和对应的Release名。并在流程中对包名中包含的release信息和Release名做校验，不一致的话天梯流程在第一步失败。
