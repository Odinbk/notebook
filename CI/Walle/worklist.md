# Checklist

* 周三下班前清理生产环境数据，审核服数据不动。周五清理数据，可以全清。
* net.core.somaxconn=32768
* net.ipv4.ip_local_port_range: 32768~60999
* 天梯流程需要调整，改为需要审核。
* 演练自动开服，演练结束后清理数据。
* 自动开服短时间开服限制，例如1小时内开了N个服务器，可能是存在bug。
* Global，Notice，VMS混布可能需要拆分
* 服务端口健康检查
* 自动开服脚本频率调整为1分钟，进程加锁保护，上一次操作没完成，下一次直接退出。
* 服务器开服时间调整为上线当天.


## DK上线运维准备工作

* 标准化，一致化服务器创建流程，快速扩容，灾难恢复。
* 线上服务器环境，数据库云服务等基础环境监控，告警。
* 对游戏服务进程，端口存活监控，告警。
* 游戏服务异常退出自动拉起恢复。
* 收集客户端运行状态，错误信息，设置告警。
* 服务器日志，BI日志自动化归档，上传云存储。
* 天梯自动化运维平台，运维操作脚本化，避免手工操作。
* 运维流程演练： 扩容，服务器宕机恢复，游戏服务故障处理。
* 数据库容灾测试，回档方案。
* 线上问题响应链 7 * 24小时，节假日，值班安排。


## 服务器紧急操作

### 更换机器

1. [运维]登录服务器确认机器状态是否可以登录，确认故障点。通知大神圈运维通过华为云后台确认机器状态，评估恢复时间。
    - [运营]发布紧急区服紧急维护公告。
    - 由于GlobalServer逻辑问题，区服会自动进入维护状态，运维不能设置区服维护，否则区服信息会从客户端消失。后续gloabl逻辑调整后调整流程。

1. [运维]备用服务器配置业务服务; 删除故障机的业务服务配置; 调整区服对应的机器信息。
1. [大神圈运维]关闭故障机机器。
1. [运维，后端]检查/online_runtime_server/gs/{server_id} 配置结应该不存在
1. [运维]初始化机器，推送服务包，管理工具，启动logbus.
1. [运维，后端]检查/online_runtime_server/gs/{server_id} ip设置是否已更新成新的ip.
1. [运维，后端]检查ZK中/online_runtime/gs/{server_id}/open_datetime, maintian, /cmdb/section/{cluseter}/gs/{id} 区组IP已经替换为新的IP
1. [运维，后端]手动启动业务服务. (游戏启动后，global会自动解除维护，玩家由于拿到的GameServer IP是故障机器的IP，连接失败不能进入游戏，客户端会有报错。)
1. [运维]天梯流程，设置故障区服维护。（会执行Gloabl Reload）
1. [运营，QA]白名单确认游戏正常，
1. [运维]确认新机器已纳入监控，报警系统。
1. [运维]通知运营可以解除维护
1. [运维]确认后区服解维护，保持监控一段时间, Grafana上确认故障区服人数正常。
1. [运营]运营关注故障区服充值掉单，发送补偿。撤销公告。确认单区聊天监控恢复。

### 故障机可恢复

1. 运维评估故障恢复时间，运营评估是否需要切维护。
1. 需要华为云/大神圈介入，切维护。
1. 操作超过5分钟，切维护。
