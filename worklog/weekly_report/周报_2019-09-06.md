# DevOps项目组组周报

## Walle

### Vega CI/CD接入

* 希望放开Assets模块CI的触发条件限制，计划先验证Assets增量构建，评估执行时间和性能，再决定要加打包机，TPlicence还是在机制上做调整。
* 项目组提出需求，提供Walle产生安装包，更新包的逻辑说明；VMS状态码以及状态迁移规则说明。
* 游戏的‘前往安装下载’可以跳转到最新可用的强更包下载地址，Walle配合提供last下载地址。

### TKW CI/CD接入

TKW CI/CD对接目前的状况是：

* CI遇到的问题基本上处理完毕，比较稳定。
* 可以打出安装包。
* 天梯脚本已经创建，联调完成。VMS，Notice，Global无状态服务同时支持容器化和虚拟机部署。

### YK CI/CD接入

YK CI/CD接入目前的状况是：

* 前后端CI都已经接入完成
* 后端可以通过Walle构建后端包
* 后端天梯流程，起停服脚本等都已创建，调试完成。
* 由于前后端对接还未完成，还不能通过Walle构建出前后端配合的可用包。
* YK目前还是用自己维护的打包脚本打包，CI/CD接入还没有产生生产力。
* YK的热更新（reslib）计划在TKW完成热更逻辑后开始接入。

### DK CI/CD接入

* 支持配置两个CDN地址，当首要CDN支持故障不可用时，从备用CDN下载更新。托马斯脚本改造，支持同时上传包到多个地址。

## 本周工作

* Walle支持ipa包二维码下载。
* 打包任务列表添加点击发布天梯的功能。
* 打包任务列表分页性能优化，分页数据显示基本感觉不到卡顿了。
* 天梯支持流程批量删除功能。
* 天梯流程步骤支持拖拽调整顺序，比原来靠手工调整顺序id的方式效率提高了很多。
* 托马斯上传版本包到CDN支持多个目标地址，支持华为云，腾讯云，阿里云的对象存储服务。用官方提供的python SDK重构了代码，替换原来Command Line工具的上传方式，thomas_upload任务现在可以在任意一台打包机上执行。
* 为TWK创建对象存储目录。前端日志上传，日志获取查看的方式下周和TWK对接。
* Notice，Noitce API容器化部署上线。

## 下周计划

* 设计实现CI任务在jenkins中排队/丢弃/保持等逻辑，对现在的任务调度方式可能需要做较大的改动。
* 处理Vega最近提出的需求。
* 天梯工具优化，记忆用户选择。
* 日本区K8s集群采购，建设。

## 故障与事故

时间: 9月4日晚 8：30 ~ 10：40
事件: Walle，天梯不可用。
原因: 内网K8s集群由于内部通信使用的自签名证书过期，导致集群故障。
处理: 临时拉起虚拟机部署的Walle和天梯备用，更新证书，恢复K8s集群。
跟进: 整理故障原因，记录文档，定时更新证书。整理Walle和天梯的容灾方案，后续演练故障恢复。

### 相关文档

* [Jenkins任务组织](https://git.youle.game/TC/TSD/DevOps/dune/wikis/jenkins_authorization)
* [CI/CD系统接入Step By Step文档](https://git.youle.game/TC/TSD/DevOps/dune/wikis/integrate_walle_step_by_step)
* [GameStatic/Patch](https://git.youle.game/TC/TSD/DevOps/dune/wikis/Release-Note-v0.1.2)
* [服务器端灰度/审核服方案](https://git.youle.game/TC/TSD/DevOps/dune/wikis/%E5%90%8E%E7%AB%AF%E6%96%87%E6%A1%A3/appstore_review_and_gray)
* [客户端灰度发布方案](https://git.youle.game/TC/TSD/DevOps/dune/wikis/%E5%89%8D%E7%AB%AF%E6%96%87%E6%A1%A3/gray-server)
* [客户端审核服方案](https://git.youle.game/TC/TSD/DevOps/dune/wikis/%E5%89%8D%E7%AB%AF%E6%96%87%E6%A1%A3/apple-review-version)
